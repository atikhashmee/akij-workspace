server {
    listen 80;
    server_name akijair.test;

    add_header X-Debug "nginx-active" always;

    location /amadeus/ {
        add_header X-Location-Match "amadeus" always;
        alias /var/www/amadeus/public/;
        index index.php index.html;
        try_files $uri $uri/ @amadeus;
    }

    location @amadeus {
        add_header X-Location-Match "amadeus-fallback" always;
        rewrite ^/amadeus/(.*)$ /amadeus/index.php?$query_string last;
    }

    location ~ ^/amadeus/(.*\.php)$ {
        add_header X-Location-Match "amadeus-php" always;
        alias /var/www/amadeus/public/;
        include fastcgi_params;
        fastcgi_pass amadeus:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/public/$1;
        
        # Additional fastcgi params for Laravel
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
    }

    location /zenith/ {
        add_header X-Location-Match "zenith" always;
        alias /var/www/zenith/public/;
        index index.php index.html;
        try_files $uri $uri/ @zenith;
    }

    location @zenith {
        add_header X-Location-Match "zenith-fallback" always;
        rewrite ^/zenith/(.*)$ /zenith/index.php?$query_string last;
    }

    location ~ ^/zenith/(.*\.php)$ {
        add_header X-Location-Match "zenith-php" always;
        alias /var/www/zenith/public/;
        include fastcgi_params;
        fastcgi_pass zenith:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/public/$1;
        
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
    }

    location /payment-gateway/ {
        add_header X-Location-Match "payment-gateway" always;
        alias /var/www/payment-gateway/public/;
        index index.php index.html;
        try_files $uri $uri/ @payment_gateway;
    }

    location @payment_gateway {
        add_header X-Location-Match "payment-gateway-fallback" always;
        rewrite ^/payment-gateway/(.*)$ /payment-gateway/index.php?$query_string last;
    }

    location ~ ^/payment-gateway/(.*\.php)$ {
        add_header X-Location-Match "payment-gateway-php" always;
        alias /var/www/payment-gateway/public/;
        include fastcgi_params;
        fastcgi_pass payment-gateway:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/public/$1;
        
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
    }

    location /core-api/ {
        add_header X-Location-Match "core-api" always;
        alias /var/www/core-api/public/;
        index index.php index.html;
        try_files $uri $uri/ @core_api;
    }

    location @core_api {
        add_header X-Location-Match "core-api-fallback" always;
        rewrite ^/core-api/(.*)$ /core-api/index.php?$query_string last;
    }

    location ~ ^/core-api/(.*\.php)$ {
        add_header X-Location-Match "payment-gateway-php" always;
        alias /var/www/core-api/public/;
        include fastcgi_params;
        fastcgi_pass core-api:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/public/$1;

        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
    }

    location / {
        add_header X-Location-Match "root" always;
        root /var/www;
        index default.html;
        try_files $uri $uri/ /default.html;
    }

    location ~ /\.ht {
        deny all;
    }
}
